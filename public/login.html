<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sorare NBA Manager</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .login-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .login-step {
            display: none;
        }
        
        .login-step.active {
            display: block;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--border-color);
            color: var(--text-secondary);
            margin: 0 1rem;
            font-weight: 600;
        }
        
        .step.active {
            background: var(--primary-color);
            color: white;
        }
        
        .step.completed {
            background: #4caf50;
            color: white;
        }
        
        .code-input {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 0.5rem;
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 2rem;">üèÄ Login Sorare NBA</h1>
        
        <div class="login-container">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">‚úì</div>
            </div>

            <!-- Step 1: Inizio Login -->
            <div class="login-step active" id="login-step1">
                <h2>üîê Connetti Account Sorare</h2>
                <p>Per accedere alle tue carte NBA, devi autorizzare l'app con il tuo account Sorare.</p>
                
                <div class="features-list">
                    <div class="feature">‚úÖ Accesso sicuro alle tue carte NBA</div>
                    <div class="feature">‚úÖ Proiezioni personalizzate</div>
                    <div class="feature">‚úÖ Lineup optimizer</div>
                </div>
                
                <button onclick="startLogin()" class="btn btn--primary" style="width: 100%; margin-top: 2rem;">
                    üöÄ Inizia Login
                </button>
            </div>

            <!-- Step 2: Codice 2FA -->
            <div class="login-step" id="login-step2">
                <h2>üìß Codice di Verifica</h2>
                <p>Inserisci il codice di verifica che hai ricevuto via email da Sorare:</p>
                
                <input 
                    type="text" 
                    id="twofa-code" 
                    class="code-input" 
                    placeholder="000000" 
                    maxlength="6"
                    pattern="[0-9]{6}"
                >
                
                <div style="margin: 1rem 0;">
                    <button onclick="verifyCode()" class="btn btn--primary" style="width: 100%;">
                        <span id="verify-text">üîë Verifica Codice</span>
                        <span id="verify-loading" class="loading" style="display: none;"></span>
                    </button>
                </div>
                
                <div class="text-center">
                    <small style="color: var(--text-secondary);">
                        Non hai ricevuto il codice? 
                        <a href="#" onclick="startLogin()" style="color: var(--primary-color);">Richiedi nuovo codice</a>
                    </small>
                </div>

                <div id="error-message" style="display: none; color: #f44336; text-align: center; margin-top: 1rem;"></div>
            </div>

            <!-- Step 3: Successo -->
            <div class="login-step" id="login-step3">
                <div style="text-align: center;">
                    <h2>üéâ Login Completato!</h2>
                    <p style="color: #4caf50; font-weight: 600;">Hai effettuato l'accesso con successo!</p>
                    <p>Ora puoi accedere alle tue carte NBA personali.</p>
                    
                    <a href="/" class="btn btn--primary" style="margin-top: 2rem;">
                        üèÄ Vai alle Tue Carte NBA
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let otpSessionChallenge = null;

        async function startLogin() {
            setStep(1);
            showLoading('Contattando Sorare...');
            
            try {
                const response = await fetch('/api/auth/login');
                const data = await response.json();
                
                if (data.requiresTwoFA) {
                    otpSessionChallenge = data.otpSessionChallenge;
                    setStep(2);
                    hideLoading();
                    document.getElementById('twofa-code').focus();
                } else if (data.hasJWT) {
                    setStep(3);
                    hideLoading();
                } else {
                    showError(data.message || 'Errore di login');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Errore di connessione');
            }
        }

        async function verifyCode() {
            const code = document.getElementById('twofa-code').value;
            
            if (code.length !== 6) {
                showError('Il codice deve essere di 6 cifre');
                return;
            }
            
            showLoading('Verificando codice...');
            
            try {
                const url = `/api/auth/login?code=${code}&challenge=${otpSessionChallenge}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.hasJWT) {
                    setStep(3);
                    hideLoading();
                } else {
                    hideLoading();
                    showError(data.error || 'Codice non valido');
                }
            } catch (error) {
                console.error('Verification error:', error);
                hideLoading();
                showError('Errore di verifica');
            }
        }

        function setStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.login-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // Show current step
            document.getElementById(`login-step${stepNumber}`).classList.add('active');
        }

        function showLoading(message) {
            document.getElementById('verify-text').style.display = 'none';
            document.getElementById('verify-loading').style.display = 'inline-block';
        }

        function hideLoading() {
            document.getElementById('verify-text').style.display = 'inline';
            document.getElementById('verify-loading').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            hideLoading();
        }

        // Auto-format 2FA code
        document.getElementById('twofa-code').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length === 6) {
                verifyCode();
            }
        });
    </script>
</body>
</html>
